![avatar](http://pythonup.cn/static/public/picture/122.jpeg)

# 有点B树

## 二叉树
> Binary Search Trees

* 二叉树是每个结点最多有两个子树的树结构
* 通常子树被称作“左子树”（left subtree）和“右子树”（right subtree）
* 二叉树常被用于实现二叉查找树和二叉堆
* 二叉树有如下特性：
1. 每个结点都包含一个元素以及n个子树，这里0≤n≤2。
2. 左子树和右子树是有顺序的，次序不能任意颠倒。左子树的值要小于父结点，右子树的值要大于父结点。

> 当插入的数据偏向一个方向时，一棵树退化为一个线性链表

## 平衡二叉树
> AVL Trees

* 它的左右两个子树的高度差的绝对值不超过1，并且左右两个子树都是一棵平衡二叉树

##### 现实中
> 随着数据的增加树高会不断增加。这时查询如果是内存操作，效率也是很高的
> 但是我们数据库中的数据基本都是放在磁盘中的，每读取一个二叉树的结点就是一次磁盘IO

## B-Tree
> 把这棵树压缩一下，让每一层能够容纳更多的节点

##### 特性

1. 每个结点最多m个子结点
2. 除了根结点和叶子结点外，每个结点最少有m/2（向上取整）个子结点
3. 如果根结点不是叶子结点，那根结点至少包含两个子结点
4. 所有的叶子结点都位于同一层
5. 每个结点都包含k个元素（关键字），这里m/2≤k<m，这里m 2向下取整
6. 每个元素（关键字）字左结点的值，都小于或等于该元素（关键字）。右结点的值都大于或等于该元素（关键字）

## B+Tree
> 优化：数据只存在叶子节点，叶子节点连起来方便区间查询

##### 特性
1. 所有的非叶子节点只存储关键字信息
2. 所有卫星数据（具体数据）都存在叶子结点中
3. 所有的叶子结点中包含了全部元素的信息
4. 所有叶子节点之间都有一个链指针

##### 对比
1. B-Tree因为非叶子结点也保存具体数据，所以在查找某个关键字的时候找到即可返回。而B+Tree所有的数据都在叶子结点，每次查找都得到叶子结点。所以在同样高度的B-Tree和B+Tree中，B-Tree查找某个关键字的效率更高

2. 由于B+Tree所有的数据都在叶子结点，并且结点之间有指针连接，在找大于某个关键字或者小于某个关键字的数据的时候，B+Tree只需要找到该关键字然后沿着链表遍历就可以了，而B-Tree还需要遍历该关键字结点的根结点去搜索

3. 由于B-Tree的每个结点（这里的结点可以理解为一个数据页）都存储主键+实际数据，而B+Tree非叶子结点只存储关键字信息，而每个页的大小有限是有限的，所以同一页能存储的B-Tree的数据会比B+Tree存储的更少。这样同样总量的数据，B-Tree的深度会更大，增大查询时的磁盘I/O次数，进而影响查询效率

## 存储

![avatar](http://pythonup.cn/static/public/picture/122_1.jpg)

* 叶子节点以数据块(页)储存，相互之间双向连接，可以理解为对文件系统按块储存的一种抽象
* 上层的节点也可以看做一张表，只有俩字段主键和页号，也放在了一个个(页)中
* 聚簇索引叶子节点储存了一条记录的所有字段
* 二级索引叶子节点只储存了索引值和主键值，复合索引的存在一定程度上减少了回表

![avatar](http://pythonup.cn/static/public/picture/122_2.jpg)

## 索引

##### 自增主键

* 每次插入一条新记录,都是追加操作
* 都不涉及到挪动其他记录,也不会触发叶子节点的分裂
* 省空间

##### 索引唯一

> 查找

* 对于普通索引来说,查找到满足条件的第一个记录后,需要查找下一个记录,直到碰到第一个不满足条件的记录
* 对于唯一索引来说,由于索引定义了唯一性,查找到第一个满足条件的记录后,就会停止继续检索

> 更新

* 对于普通索引来说,则是将更新记录在 change buffer,语句执行就结束了
* 对于唯一索引来说,需要将数据⻚读入内存,判断到没有冲突,插入这个值,语句执行结束

> change buffer

* 减少了随机磁盘访问,所以对更新性能的提升是会很明显的
* InnoDB 的数据是按数据⻚为单位来读写的
* 每个数据⻚的大小默认是 16KB
* redo log 主要节省的是随机写磁盘的 IO 消耗
* change buffer 主要节省的则是随机读磁盘的 IO 消耗

##### 联合索引

* 最左前缀：只要查询条件里有第一个字段就可以
* like '*%'可以只用索引
* 覆盖索引最左定位数据，减少回表

## 题外话

##### AVL
* 左右高度相差不超过1
* 每个节点需要储存整形的高度

##### 红黑树
* 左右高度相差不超过一倍
* 每个节点需要储存布尔的颜色

##### 优势
* 不严格平衡
* 依然LogN
* 省空间

